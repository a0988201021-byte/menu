<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®æ³¨æ–‡ - å„ªåŒ–ç‰ˆ</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        * { font-family: 'Noto Sans TC', sans-serif !important; }

        body { 
            background-color: #fdfaf5; 
            color: #333; 
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent; 
        }

        /* --- ä¿®æ­£ï¼šæˆå“¡èˆ‡åˆ†é¡æŒ‰éˆ•è®Šç‚ºåœ“è§’è† å›Š --- */
        .chip { 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 14px !important; /* ç¸®å°ä¸€é»ï¼Œé©é…å¤šè¡Œé¡¯ç¤º */
            border-radius: 9999px !important;
            font-weight: 700;
            font-size: 13px; /* å­—é«”å¾®èª¿å°ä¸€é» */
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .chip-selected { 
            background-color: #6b7280 !important;
            color: white !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chip-unselected { 
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 15px 0 10px 0;
        }

        .action-icons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .del-x { 
            margin-left: 4px;
            width: 14px;
            height: 14px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        .card-pro { background: white; border-radius: 32px; border: 1px solid #f0f0f0; }

        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #7d968b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-40">

    <!-- é ‚éƒ¨å°è¦½åˆ—ï¼šåŒ…å«å›ºå®šåˆ†é¡èˆ‡æˆå“¡ -->
    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-xl border-b border-stone-100 shadow-sm">
        <div class="max-w-md mx-auto px-5">
            <div class="header-container">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-[#7d968b] rounded-xl flex items-center justify-center text-white text-lg font-black">L</div>
                    <span class="text-xl font-black tracking-tighter text-stone-800">æ—…ã®æ³¨æ–‡</span>
                </div>
                <div class="action-icons">
                    <button onclick="setupApiKey()" class="icon-btn text-stone-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button onclick="clearAllData()" class="icon-btn text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
            </div>
            
            <!-- ä¿®æ­£ï¼šæˆå“¡åˆ—è¡¨æ”¹ç‚ºè‡ªå‹•æŠ˜è¡Œ (Flex Wrap) -->
            <div class="flex flex-wrap gap-y-2 gap-x-1 mb-3" id="friendListContainer"></div>

            <!-- ä¿®æ­£ï¼šåˆ†é¡é¸å–®æ”¾é€² Nav ä¸¦ç¶­æŒå›ºå®š -->
            <div id="categoryWrapper" class="hidden">
                <div class="flex space-x-1.5 overflow-x-auto no-scrollbar pb-3" id="categoryTabs"></div>
            </div>

            <div id="navTabs" class="hidden flex border-t border-stone-50">
                <button onclick="switchTab('menu')" id="tab-menu" class="flex-1 py-3 text-sm font-black border-b-4 border-stone-800 text-stone-800">èœå–®é»é¤</button>
                <button onclick="switchTab('bill')" id="tab-bill" class="flex-1 py-3 text-sm font-black text-stone-300 border-b-4 border-transparent">åˆ†å¸³çµç®—</button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-5 space-y-6">
        <div id="restaurantInfoBox" class="hidden bg-[#fefce8] p-6 rounded-[2rem] border border-yellow-100 shadow-sm text-sm">
            <div class="flex items-center gap-2 font-black text-yellow-800 mb-2">ğŸ“„ èœå–®å‚™è¨»äº‹é …</div>
            <div id="restaurantInfoContent" class="text-yellow-700 leading-relaxed font-medium"></div>
        </div>

        <div id="uploadSection" class="bg-white p-10 rounded-[2.5rem] border-2 border-dashed border-stone-200 text-center shadow-sm">
            <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
            <label for="fileInput" class="cursor-pointer flex flex-col items-center">
                <div class="w-20 h-20 bg-stone-50 rounded-[2rem] flex items-center justify-center mb-4 text-[#7d968b]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </div>
                <div class="text-stone-800 font-black text-xl">æ‹æ”èœå–® / ä¸Šå‚³ç…§ç‰‡</div>
                <div class="text-stone-400 mt-2 font-bold text-xs">AI å°‡è‡ªå‹•è¾¨è­˜åƒ¹æ ¼ä¸¦ç¿»è­¯</div>
            </label>
            <div id="previewArea" class="mt-8 grid grid-cols-3 gap-2"></div>
            <button id="analyzeBtn" class="mt-8 w-full bg-[#7d968b] text-white py-5 rounded-[2rem] font-black hidden shadow-lg flex items-center justify-center gap-2">ğŸš€ é–‹å§‹ AI è§£æ</button>
        </div>

        <div id="mainContent" class="hidden space-y-4">
            <div id="view-menu" class="space-y-4">
                <div id="menuListContainer" class="flex flex-col gap-3"></div>
                <button onclick="document.getElementById('fileInput').click()" class="w-full py-6 border-2 border-dashed border-stone-200 rounded-[2rem] text-stone-300 font-black hover:bg-white transition-all">+ è¿½åŠ èœå–®ç…§ç‰‡</button>
            </div>
            <div id="view-bill" class="hidden space-y-4">
                <div class="card-pro p-6 bg-stone-50/50 flex justify-between items-center text-sm font-black">
                    <span>ğŸ·ï¸ æœå‹™ç¨…è²»åŠ æˆ (%)</span>
                    <input type="number" id="taxRateInput" value="0" onchange="updateFinanceSettings()" class="w-16 bg-white border border-stone-200 rounded-xl py-2 text-center outline-none font-black shadow-sm">
                </div>
                <div id="billListContainer" class="space-y-4"></div>
            </div>
        </div>
    </main>

    <div id="footerBar" class="hidden fixed bottom-8 left-5 right-5 bg-stone-900 text-white rounded-[2.5rem] p-7 z-30 flex justify-between items-center max-w-md mx-auto shadow-2xl">
        <div>
            <div class="text-[10px] text-stone-500 font-black tracking-widest mb-1 uppercase tracking-tighter">Grand Total</div>
            <div class="font-black text-2xl tracking-tighter"><span id="grandTotal">0</span><span class="text-xs font-normal ml-1">å…ƒ</span></div>
        </div>
        <button onclick="openFinalModal()" class="bg-[#7d968b] px-10 py-4 rounded-2xl font-black text-sm active:scale-95 transition-all">ç¢ºèªè¨‚å–®</button>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[3rem] overflow-hidden shadow-2xl p-8 text-center space-y-8">
            <h2 class="text-2xl font-black">é»é¤ç¢ºèªæ¸…å–®</h2>
            <div id="finalOrderList" class="bg-stone-50 rounded-[2rem] p-6 text-left max-h-[45vh] overflow-y-auto space-y-5 border border-stone-100 no-scrollbar"></div>
            <div class="flex flex-col gap-2">
                <button onclick="copyOrderToClipboard()" class="w-full py-5 bg-stone-900 text-white rounded-2xl font-black">ğŸ“‹ è¤‡è£½å…§å®¹ (LINE)</button>
                <button onclick="document.getElementById('orderModal').classList.add('hidden')" class="w-full py-2 text-stone-400 font-bold">è¿”å›ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        const MODEL_LIST = ["gemini-1.5-flash", "gemini-2.0-flash"];
        let menuItems = [], friends = [];
        let restaurantInfo = "", currentFriendId = 'share', currentCategory = 'å…¨éƒ¨', globalIdCounter = 0;
        let taxRate = 0;

        function getStoredApiKey() { return localStorage.getItem('gemini_api_key') || ""; }
        function setupApiKey() {
            const key = prompt("è«‹è¼¸å…¥ Gemini API Key:", getStoredApiKey());
            if (key !== null) { localStorage.setItem('gemini_api_key', key.trim()); alert("API Key å·²å„²å­˜"); }
        }

        function saveData() {
            localStorage.setItem('menu_v15_items', JSON.stringify({ menuItems, restaurantInfo, taxRate, globalIdCounter }));
            localStorage.setItem('menu_v15_friends', JSON.stringify(friends));
        }

        function loadData() {
            const itemsSaved = localStorage.getItem('menu_v15_items');
            const friendsSaved = localStorage.getItem('menu_v15_friends');
            friends = friendsSaved ? JSON.parse(friendsSaved) : [{ id: 'share', name: 'å…±åŒ', cart: {} }];
            if (itemsSaved) {
                const data = JSON.parse(itemsSaved);
                menuItems = data.menuItems || [];
                restaurantInfo = data.restaurantInfo || "";
                taxRate = data.taxRate || 0;
                globalIdCounter = data.globalIdCounter || 0;
                document.getElementById('taxRateInput').value = taxRate;
                if (menuItems.length > 0) showMainApp();
            }
            renderFriendList();
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('footerBar').classList.remove('hidden');
            document.getElementById('navTabs').classList.remove('hidden');
            document.getElementById('categoryWrapper').classList.remove('hidden');
            renderMenu(); renderInfo();
        }

        function addFriend() {
            const n = prompt('è¼¸å…¥æ–°æˆå“¡åå­—ï¼š');
            if (n) { friends.push({ id: 'f_' + Date.now(), name: n, cart: {} }); saveData(); renderFriendList(); }
        }

        function removeFriend(e, id) {
            e.stopPropagation();
            if (id === 'share') return;
            if (confirm(`ç¢ºå®šç§»é™¤æ­¤æˆå“¡ï¼Ÿ`)) {
                friends = friends.filter(f => f.id !== id);
                if (currentFriendId === id) currentFriendId = 'share';
                saveData(); renderFriendList(); renderMenu();
            }
        }

        function renderFriendList() {
            const container = document.getElementById('friendListContainer');
            container.innerHTML = `<div onclick="addFriend()" class="chip chip-unselected" style="border: 2px dashed #ddd;">ï¼‹ æ–°å¢</div>`;
            friends.forEach(f => {
                const isActive = f.id === currentFriendId;
                const div = document.createElement('div');
                div.className = `chip ${isActive ? 'chip-selected' : 'chip-unselected'}`;
                div.innerHTML = `<span>${f.name}</span>${f.id !== 'share' ? `<span class="del-x" onclick="removeFriend(event, '${f.id}')">âœ•</span>` : ''}`;
                div.onclick = () => { currentFriendId = f.id; renderFriendList(); renderMenu(); };
                container.appendChild(div);
            });
        }

        async function analyzeMenu(base64Data) {
            const apiKey = getStoredApiKey();
            if (!apiKey) { setupApiKey(); throw new Error("è«‹å¡«å…¥ API Key"); }
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¤šåœ‹èªè¨€èœå–®åˆ†æå®˜ã€‚è«‹åŸ·è¡Œï¼š
            1. å°‡è¾¨è­˜åˆ°çš„èªè¨€å…¨éƒ¨ç¿»è­¯ç‚ºã€Œç¹é«”ä¸­æ–‡ã€(Traditional Chinese)ã€‚
            2. æ­¸é¡ã€Œcategoryã€ç‚ºï¼šä¸»é£Ÿã€é£²å“ã€å°èœã€ç”œé»ã€æˆ–å…¶å®ƒï¼ˆç¹é«”ä¸­æ–‡ï¼‰ã€‚
            3. ã€Œsupplementary_infoã€æ¬„ä½ï¼šåƒ…æå–ç…§ç‰‡ä¸­é—œæ–¼ä½æ¶ˆã€é™æ™‚ã€æœå‹™è²»ç­‰å¯¦é«”è¦å‰‡ï¼Œä¸¦ä¸”ã€çµ•å°å¿…é ˆç¿»è­¯ç‚ºç¹é«”ä¸­æ–‡ã€‘ã€‚
            4. é™¤äº† original æ¬„ä½ï¼Œå…¶å®ƒ JSON è¼¸å‡ºåš´ç¦å‡ºç¾å¤–æ–‡ã€‚è‹¥ç„¡å‚™è¨»å‰‡ç•™ç©ºã€‚
            JSON: {"items": [{"original": "åŸæ–‡", "translated": "åç¨±", "price": 100, "category": "åˆ†é¡", "dietary": "ç¦å¿Œ", "is_recommended": boolean}], "supplementary_info": "ç¹é«”ä¸­æ–‡å‚™è¨»è³‡è¨Š"}`;

            for (let model of MODEL_LIST) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Data } }] }], generationConfig: { response_mime_type: "application/json" } })
                    });
                    const data = await res.json();
                    if (res.ok) return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { console.error(e); }
            }
            throw new Error("è§£æå¤±æ•—");
        }

        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            const btn = this;
            const files = Array.from(document.getElementById('fileInput').files);
            btn.disabled = true; btn.innerHTML = `<div class="loader"></div> <span>AI è§£æä¸­...</span>`;
            try {
                for (let f of files) {
                    const b64 = await compressImage(f);
                    const res = await analyzeMenu(b64);
                    if (res.items) {
                        menuItems = [...menuItems, ...res.items.map(it => ({ ...it, id: 'it_' + (globalIdCounter++), price: parseFloat(it.price)||0 }))];
                        if (res.supplementary_info) restaurantInfo += (restaurantInfo ? " " : "") + res.supplementary_info;
                    }
                }
                saveData(); showMainApp();
            } catch (err) { alert(err.message); btn.disabled = false; btn.innerHTML = "ğŸš€ é–‹å§‹ AI è§£æ"; }
        });

        function renderMenu() {
            const container = document.getElementById('menuListContainer');
            const catTabs = document.getElementById('categoryTabs');
            const cats = ['å…¨éƒ¨', ...new Set(menuItems.map(i => i.category || 'å…¶å®ƒ'))];
            catTabs.innerHTML = cats.map(c => `<div onclick="currentCategory='${c}'; renderMenu();" class="chip ${currentCategory === c ? 'chip-selected' : 'chip-unselected'}">${c}</div>`).join('');

            const filtered = currentCategory === 'å…¨éƒ¨' ? menuItems : menuItems.filter(i => (i.category||'å…¶å®ƒ') === currentCategory);
            container.innerHTML = filtered.map(item => {
                const qty = friends.find(f => f.id === currentFriendId).cart[item.id] || 0;
                return `<div class="card-pro p-6 flex flex-col gap-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="font-black text-stone-800 text-lg leading-tight">${item.is_recommended ? 'â­ ' : ''}${item.translated}</div>
                            <div class="text-[11px] text-stone-400 mt-1 font-bold">${item.original}</div>
                            ${item.dietary ? `<div class="text-[10px] text-red-500 font-black mt-2 bg-red-50 inline-block px-2 py-0.5 rounded-lg">âš ï¸ ${item.dietary}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-black text-[#7d968b] text-xl">${item.price}<span class="text-[10px] ml-0.5">å…ƒ</span></div>
                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.original)}&tbm=isch" target="_blank" class="text-[10px] text-stone-300 underline font-black mt-2 inline-block">ğŸ” æœå°‹åœ–ç‰‡</a>
                        </div>
                    </div>
                    <div class="flex justify-end items-center gap-6">
                        <div onclick="updateCart('${item.id}', -1)" class="w-12 h-12 rounded-2xl bg-stone-100 text-stone-400 font-black text-2xl flex items-center justify-center">ï¼</div>
                        <span class="text-3xl font-black min-w-[2rem] text-center">${qty}</span>
                        <div onclick="updateCart('${item.id}', 1)" class="w-12 h-12 rounded-2xl bg-[#7d968b] text-white font-black text-2xl flex items-center justify-center">ï¼‹</div>
                    </div>
                </div>`;
            }).join('');
            updateGrandTotal();
        }

        function renderBill() {
            const container = document.getElementById('billListContainer');
            container.innerHTML = friends.map(f => {
                let sub = 0, itemsHtml = '';
                Object.entries(f.cart).forEach(([id, q]) => {
                    const it = menuItems.find(m => m.id === id);
                    if (it) { sub += it.price * q; itemsHtml += `<div class="flex flex-col py-3 border-b border-stone-50 font-bold"><div class="flex justify-between text-sm"><span>${it.translated} x ${q}</span><span>${(it.price * q).toLocaleString()}å…ƒ</span></div><div class="text-[10px] text-stone-300">${it.original}</div></div>`; }
                });
                const total = sub * (1 + taxRate / 100);
                if (sub === 0 && f.id !== 'share') return '';
                return `<div class="card-pro p-7"><div class="flex justify-between items-center border-b pb-5 mb-5"><div class="text-2xl font-black">${f.name}</div><div class="text-2xl font-black text-[#7d968b]">${total.toLocaleString()}å…ƒ</div></div><div class="space-y-1 mb-5">${itemsHtml || '<div class="text-xs text-stone-300 text-center">å°šæœªé»é¤</div>'}</div>${sub > 0 ? `<div class="bg-stone-50 p-4 rounded-2xl text-xs font-bold text-stone-400"><div class="flex justify-between"><span>å°è¨ˆ</span><span>${sub}å…ƒ</span></div><div class="flex justify-between"><span>æœå‹™ç¨…è²» (${taxRate}%)</span><span>+${(sub*taxRate/100).toFixed(0)}å…ƒ</span></div></div>` : ''}</div>`;
            }).join('');
        }

        function updateGrandTotal() {
            let t = 0; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { const it = menuItems.find(m => m.id === id); if (it) t += it.price * q; }); });
            document.getElementById('grandTotal').innerText = (t * (1 + taxRate / 100)).toLocaleString();
        }

        function updateFinanceSettings() { taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0; saveData(); updateGrandTotal(); if (document.getElementById('tab-bill').classList.contains('text-stone-800')) renderBill(); }

        function switchTab(t) {
            const isMenu = t === 'menu';
            document.getElementById('view-menu').classList.toggle('hidden', !isMenu);
            document.getElementById('view-bill').classList.toggle('hidden', isMenu);
            // åˆ‡æ›æ™‚é¡¯ç¤º/éš±è—åˆ†é¡é¸å–® (åªæœ‰é¸èœæ™‚éœ€è¦)
            document.getElementById('categoryWrapper').classList.toggle('hidden', !isMenu);
            
            document.getElementById('tab-menu').className = `flex-1 py-4 text-sm font-black border-b-4 ${isMenu ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-300'}`;
            document.getElementById('tab-bill').className = `flex-1 py-4 text-sm font-black border-b-4 ${!isMenu ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-300'}`;
            if (!isMenu) renderBill();
        }

        function clearAllData() {
            if (confirm("æ¸…é™¤èœå–®èˆ‡é»é¤å…§å®¹ï¼Ÿï¼ˆæˆå“¡æ¸…å–®å°‡ä¿ç•™ï¼‰")) {
                menuItems = []; restaurantInfo = ""; globalIdCounter = 0;
                friends.forEach(f => { f.cart = {}; });
                saveData(); location.reload();
            }
        }

        async function compressImage(file) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 1100;
                    if (w > max || h > max) { if (w > h) { h *= max/w; w = max; } else { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function updateCart(itemId, delta) {
            const f = friends.find(f => f.id === currentFriendId);
            const n = (f.cart[itemId] || 0) + delta;
            if (n >= 0) { if (n === 0) delete f.cart[itemId]; else f.cart[itemId] = n; saveData(); renderMenu(); }
        }

        function copyOrderToClipboard() {
            const tot = {}; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { tot[id] = (tot[id] || 0) + q; }); });
            let txt = "ğŸ“‹ é»é¤æ‘˜è¦:\n"; Object.entries(tot).forEach(([id, q]) => { const it = menuItems.find(m => m.id === id); txt += `â€¢ ${it.original} (${it.translated}) x ${q}\n`; });
            navigator.clipboard.writeText(txt).then(() => alert("è¨‚å–®å…§å®¹å·²è¤‡è£½"));
        }

        // --- ä¿®æ­£ï¼šè¨‚å–®æ‘˜è¦ Modal æ’ç‰ˆå„ªåŒ– ---
        function openFinalModal() {
            const tot = {}; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { tot[id] = (tot[id] || 0) + q; }); });
            const list = document.getElementById('finalOrderList');
            if (Object.keys(tot).length === 0) return;
            
            list.innerHTML = Object.entries(tot).map(([id, q]) => {
                const it = menuItems.find(m => m.id === id);
                return `
                <div class="flex justify-between items-center border-b border-stone-100 pb-4 gap-4">
                    <div class="flex-1 min-w-0"> <!-- åç¨±ä½”æ“šå‰©é¤˜ç©ºé–“ -->
                        <span class="font-black text-stone-900 block leading-tight text-lg truncate">${it.original}</span>
                        <span class="text-[11px] text-stone-400 block mt-1 truncate">${it.translated}</span>
                    </div>
                    <div class="text-3xl font-black text-[#7d968b] shrink-0 whitespace-nowrap"> <!-- ä»½æ•¸ä¸æŠ˜è¡Œã€ä¸ç¸®å° -->
                        x ${q}
                    </div>
                </div>`;
            }).join('');
            document.getElementById('orderModal').classList.remove('hidden');
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const area = document.getElementById('previewArea'); area.innerHTML = '';
            document.getElementById('analyzeBtn').classList.remove('hidden');
            Array.from(e.target.files).forEach(f => {
                const img = document.createElement('img'); img.src = URL.createObjectURL(f);
                img.className = "w-full h-24 object-cover rounded-[1.5rem] border border-stone-100"; area.appendChild(img);
            });
        });

        function renderInfo() {
            if (restaurantInfo.trim()) { document.getElementById('restaurantInfoBox').classList.remove('hidden'); document.getElementById('restaurantInfoContent').innerText = restaurantInfo; }
        }

        loadData();
    </script>
</body>
</html>