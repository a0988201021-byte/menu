<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®æ³¨æ–‡ - å°ˆæ¥­ç©©å®šç‰ˆ</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        * { font-family: 'Noto Sans TC', sans-serif !important; }

        body { 
            background-color: #fdfaf5; color: #333; 
            margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- åœ“è§’è† å›ŠæŒ‰éˆ• --- */
        .chip { 
            display: inline-flex; align-items: center; justify-content: center;
            padding: 5px 12px !important; border-radius: 9999px !important;
            font-weight: 700; font-size: 12px; transition: all 0.2s; border: none; cursor: pointer; white-space: nowrap;
        }

        /* é¸ä¸­ç‹€æ…‹å€éš” */
        .chip-selected { background-color: #6b7280 !important; color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cat-selected { background-color: #7d968b !important; color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chip-unselected { background-color: #f3f4f6 !important; color: #9ca3af !important; }

        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 8px 0; }
        .action-icons { display: flex; gap: 10px; align-items: center; }
        .icon-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: none; border: none; }

        .del-x { margin-left: 4px; width: 14px; height: 14px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; }

        /* é«˜å¯†åº¦èœå–®å¡ç‰‡ */
        .card-menu { background: white; border-radius: 16px; border: 1px solid #f0f0f0; padding: 10px 14px; transition: transform 0.1s; }
        
        /* åŠ è¼‰å‹•ç•« */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #7d968b; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-32 overflow-x-hidden">

    <!-- é ‚éƒ¨å°è¦½åˆ—ï¼šæˆå“¡èˆ‡åˆ†é¡å›ºå®šåœ¨é ‚éƒ¨ -->
    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-xl border-b border-stone-100 shadow-sm">
        <div class="max-w-md mx-auto px-4">
            <div class="header-container">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-[#7d968b] rounded-xl flex items-center justify-center text-white text-lg font-black shadow-sm">L</div>
                    <span class="text-xl font-black tracking-tighter text-stone-800">æ—…ã®æ³¨æ–‡</span>
                </div>
                <div class="action-icons">
                    <button onclick="setupApiKey()" class="icon-btn text-stone-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button onclick="clearAllData()" class="icon-btn text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
            </div>
            
            <!-- æˆå“¡åˆ—è¡¨ï¼šå…©è¡Œå½ˆæ€§ä½ˆå±€ -->
            <div class="flex flex-wrap gap-y-2 gap-x-1.5 mb-3" id="friendListContainer"></div>

            <!-- åˆ†é¡é¸å–®ï¼šå›ºå®šåœ¨ Nav åº•éƒ¨ -->
            <div id="categoryWrapper" class="hidden">
                <div class="flex space-x-1.5 overflow-x-auto no-scrollbar pb-3" id="categoryTabs"></div>
            </div>

            <!-- åˆ†é åˆ‡æ› -->
            <div id="navTabs" class="hidden flex border-t border-stone-50">
                <button onclick="switchTab('menu')" id="tab-menu" class="flex-1 py-3 text-xs font-black border-b-4 border-stone-800 text-stone-800">èœå–®é»é¤</button>
                <button onclick="switchTab('bill')" id="tab-bill" class="flex-1 py-3 text-xs font-black text-stone-300 border-b-4 border-transparent">åˆ†å¸³çµç®—</button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <!-- AI æé†’ (åƒ…å¯¦é«”è³‡è¨Š) -->
        <div id="restaurantInfoBox" class="hidden bg-[#fefce8] p-5 rounded-[1.5rem] border border-yellow-100 shadow-sm text-xs">
            <div class="flex items-center gap-2 font-black text-yellow-800 mb-1">ğŸ“„ èœå–®å‚™è¨»</div>
            <div id="restaurantInfoContent" class="text-yellow-700 leading-relaxed font-medium"></div>
        </div>

        <!-- åˆå§‹ä¸Šå‚³å€åŸŸ -->
        <div id="uploadSection" class="bg-white p-10 rounded-[2.5rem] border-2 border-dashed border-stone-200 text-center shadow-sm">
            <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
            <label for="fileInput" class="cursor-pointer flex flex-col items-center">
                <div class="w-16 h-16 bg-stone-50 rounded-[1.5rem] flex items-center justify-center mb-4 text-[#7d968b]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </div>
                <div class="text-stone-800 font-black text-xl">é»æ“Šæ‹æ”èœå–®</div>
            </label>
            <div id="previewArea" class="mt-6 grid grid-cols-3 gap-2"></div>
            <button id="analyzeBtn" class="mt-8 w-full bg-[#7d968b] text-white py-4 rounded-2xl font-black hidden shadow-lg flex items-center justify-center gap-2">ğŸš€ é–‹å§‹ AI è§£æ</button>
        </div>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div id="mainContent" class="hidden space-y-4">
            <div id="view-menu" class="space-y-3">
                <div id="menuListContainer" class="flex flex-col gap-2.5"></div>
                <button onclick="document.getElementById('fileInput').click()" class="w-full py-4 border-2 border-dashed border-stone-200 rounded-2xl text-stone-300 font-black text-xs hover:bg-white transition-all">+ è¿½åŠ èœå–®</button>
            </div>
            
            <div id="view-bill" class="hidden space-y-4">
                <div class="card-menu bg-stone-50/50 flex justify-between items-center text-xs font-black">
                    <span>ğŸ·ï¸ æœå‹™ç¨…è²»åŠ æˆ (%)</span>
                    <input type="number" id="taxRateInput" value="0" onchange="updateFinanceSettings()" class="w-14 bg-white border border-stone-200 rounded-lg py-1.5 text-center outline-none font-black shadow-sm">
                </div>
                <div id="billListContainer" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°è¦½ï¼šç²¾ç°¡çº–ç´°åŒ– -->
    <div id="footerBar" class="hidden fixed bottom-6 left-4 right-4 bg-stone-900 text-white rounded-[1.5rem] p-4 z-30 flex justify-between items-center max-w-md mx-auto shadow-2xl">
        <div class="pl-2">
            <div class="text-[9px] text-stone-500 font-black tracking-widest uppercase mb-0.5 tracking-tighter">Total</div>
            <div class="font-black text-xl tracking-tighter"><span id="grandTotal">0</span><span class="text-[10px] font-normal ml-0.5">å…ƒ</span></div>
        </div>
        <button onclick="openFinalModal()" class="bg-[#7d968b] px-6 py-2.5 rounded-xl font-black text-xs active:scale-95 transition-all">ç¢ºèªè¨‚å–®</button>
    </div>

    <!-- è¨‚å–®æ¸…å–® Modal -->
    <div id="orderModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 text-center space-y-6">
            <h2 class="text-xl font-black tracking-tight">é»é¤ç¢ºèªæ¸…å–®</h2>
            <div id="finalOrderList" class="bg-stone-50 rounded-[1.5rem] p-5 text-left max-h-[50vh] overflow-y-auto space-y-4 border border-stone-100 no-scrollbar"></div>
            <div class="flex flex-col gap-2">
                <button onclick="copyOrderToClipboard()" class="w-full py-4 bg-stone-900 text-white rounded-xl font-black text-sm">ğŸ“‹ è¤‡è£½å…§å®¹ (LINE)</button>
                <button onclick="document.getElementById('orderModal').classList.add('hidden')" class="w-full py-1.5 text-stone-400 font-bold text-xs">è¿”å›ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        const MODEL_LIST = ["gemini-1.5-flash", "gemini-2.0-flash"];
        const DB_KEY_ITEMS = 'travel_menu_db_items_v17';
        const DB_KEY_FRIENDS = 'travel_menu_db_friends_v17';

        let menuItems = [], friends = [];
        let restaurantInfo = "", currentFriendId = 'share', currentCategory = 'å…¨éƒ¨', globalIdCounter = 0, taxRate = 0;

        function getStoredApiKey() { return localStorage.getItem('gemini_api_key') || ""; }
        function setupApiKey() {
            const key = prompt("è¼¸å…¥æ‚¨çš„ Gemini API Key:", getStoredApiKey());
            if (key !== null) { localStorage.setItem('gemini_api_key', key.trim()); alert("Key å·²å„²å­˜"); }
        }

        function saveData() {
            localStorage.setItem(DB_KEY_ITEMS, JSON.stringify({ menuItems, restaurantInfo, taxRate, globalIdCounter }));
            localStorage.setItem(DB_KEY_FRIENDS, JSON.stringify(friends));
        }

        function loadData() {
            const iSaved = localStorage.getItem(DB_KEY_ITEMS);
            const fSaved = localStorage.getItem(DB_KEY_FRIENDS);
            friends = fSaved ? JSON.parse(fSaved) : [{ id: 'share', name: 'å…±åŒ', cart: {} }];
            if (iSaved) {
                const d = JSON.parse(iSaved);
                menuItems = d.menuItems || []; restaurantInfo = d.restaurantInfo || "";
                taxRate = d.taxRate || 0; globalIdCounter = d.globalIdCounter || 0;
                document.getElementById('taxRateInput').value = taxRate;
                if (menuItems.length > 0) showMainApp();
            }
            renderFriendList();
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('footerBar').classList.remove('hidden');
            document.getElementById('navTabs').classList.remove('hidden');
            document.getElementById('categoryWrapper').classList.remove('hidden');
            renderMenu(); renderInfo();
        }

        function addFriend() {
            const n = prompt('æˆå“¡åå­—ï¼š');
            if (n) { friends.push({ id: 'f_' + Date.now(), name: n, cart: {} }); saveData(); renderFriendList(); }
        }

        function removeFriend(e, id) {
            e.stopPropagation(); if (id === 'share') return;
            if (confirm(`ç¢ºå®šç§»é™¤æ­¤æˆå“¡ï¼Ÿ`)) {
                friends = friends.filter(f => f.id !== id);
                if (currentFriendId === id) currentFriendId = 'share';
                saveData(); renderFriendList(); renderMenu();
            }
        }

        function clearMemberCart(id) {
            if (confirm("æ¸…ç©ºæ­¤äººçš„é»é¤ç´€éŒ„ï¼Ÿ")) {
                const f = friends.find(x => x.id === id); if (f) f.cart = {};
                saveData(); renderMenu(); if (!document.getElementById('view-bill').classList.contains('hidden')) renderBill();
                updateGrandTotal();
            }
        }

        function renderFriendList() {
            const container = document.getElementById('friendListContainer');
            container.innerHTML = `<div onclick="addFriend()" class="chip chip-unselected" style="border: 1.5px dashed #ddd;">ï¼‹ æ–°å¢</div>`;
            friends.forEach(f => {
                const active = f.id === currentFriendId;
                const div = document.createElement('div');
                div.className = `chip ${active ? 'chip-selected' : 'chip-unselected'}`;
                div.innerHTML = `<span>${f.name}</span>${f.id !== 'share' ? `<span class="del-x" onclick="removeFriend(event, '${f.id}')">âœ•</span>` : ''}`;
                div.onclick = () => { currentFriendId = f.id; renderFriendList(); renderMenu(); };
                container.appendChild(div);
            });
        }

        // --- åŠ å›º AI è§£æåŠŸèƒ½ï¼šä¿®å¾© JSON å ±éŒ¯ ---
        async function analyzeMenu(base64Data) {
            const key = getStoredApiKey(); if (!key) { setupApiKey(); throw new Error("å°šæœªè¨­å®š API Key"); }
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¤šåœ‹èªè¨€èœå–®è§£æåŠ©æ‰‹ã€‚
            1. å°‡å…§å®¹ç¿»è­¯ç‚ºã€Œç¹é«”ä¸­æ–‡ã€(Traditional Chinese)ã€‚
            2. æ­¸é¡ã€Œcategoryã€ç‚ºï¼šä¸»é£Ÿã€é£²å“ã€å°èœã€ç”œé»ã€æˆ–å…¶å®ƒï¼ˆç¹é«”ä¸­æ–‡ï¼‰ã€‚
            3. ã€Œsupplementary_infoã€ï¼šåƒ…æå–ç…§ç‰‡ä¸­é—œæ–¼ä½æ¶ˆã€è¦å‰‡ç­‰å¯¦é«”å°è£½è³‡è¨Šï¼Œä¸¦ç¿»è­¯ç‚ºç¹é«”ä¸­æ–‡ã€‚è‹¥ç„¡å‰‡ç•™ç©ºã€‚
            å›å‚³æ ¼å¼åš´æ ¼è¦æ±‚ JSON: {"items": [{"original": "åŸæ–‡", "translated": "åç¨±", "price": 100, "category": "åˆ†é¡", "dietary": "ç¦å¿Œ", "is_recommended": boolean}], "supplementary_info": "è³‡è¨Š"}`;

            for (let model of MODEL_LIST) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Data } }] }], generationConfig: { response_mime_type: "application/json" } })
                    });
                    const data = await res.json();
                    if (!res.ok) continue;

                    // åŠ å›ºè™•ç†ï¼šç§»é™¤ AI å¯èƒ½åŠ å…¥çš„ Markdown èªæ³•æ¨™ç±¤
                    let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                    rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                    
                    return JSON.parse(rawText);
                } catch (e) { console.error(`æ¨¡å‹ ${model} å ±éŒ¯: `, e); }
            }
            throw new Error("AI è§£æå¤±æ•—ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦æœ‰æ•ˆã€‚");
        }

        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            const btn = this; const files = Array.from(document.getElementById('fileInput').files);
            btn.disabled = true; btn.innerHTML = `<div class="loader"></div> <span>è§£æä¸­...</span>`;
            try {
                for (let f of files) {
                    const b64 = await compressImage(f); const res = await analyzeMenu(b64);
                    if (res.items) {
                        menuItems = [...menuItems, ...res.items.map(it => ({ ...it, id: 'it_' + (globalIdCounter++), price: parseFloat(it.price)||0 }))];
                        if (res.supplementary_info) restaurantInfo += (restaurantInfo ? " " : "") + res.supplementary_info;
                    }
                }
                saveData(); showMainApp();
            } catch (err) { alert(err.message); btn.disabled = false; btn.innerHTML = "ğŸš€ é–‹å§‹ AI è§£æ"; }
        });

        function renderMenu() {
            const container = document.getElementById('menuListContainer');
            const catTabs = document.getElementById('categoryTabs');
            const cats = ['å…¨éƒ¨', ...new Set(menuItems.map(i => i.category || 'å…¶å®ƒ'))];
            
            catTabs.innerHTML = cats.map(c => `<div onclick="currentCategory='${c}'; renderMenu();" class="chip ${currentCategory === c ? 'cat-selected' : 'chip-unselected'}">${c}</div>`).join('');

            const filtered = currentCategory === 'å…¨éƒ¨' ? menuItems : menuItems.filter(i => (i.category||'å…¶å®ƒ') === currentCategory);
            container.innerHTML = filtered.map(item => {
                const qty = friends.find(f => f.id === currentFriendId).cart[item.id] || 0;
                return `<div class="card-menu flex flex-col gap-2 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0 pr-2">
                            <div class="font-bold text-stone-800 text-[14px] leading-tight">${item.is_recommended ? 'â­ ' : ''}${item.translated}</div>
                            <div class="text-[9px] text-stone-400 mt-0.5 font-bold">${item.original}</div>
                            ${item.dietary ? `<div class="text-[8px] text-red-500 font-bold mt-1 bg-red-50 inline-block px-1.5 py-0.5 rounded-lg">âš ï¸ ${item.dietary}</div>` : ''}
                        </div>
                        <div class="text-right shrink-0">
                            <div class="font-black text-[#7d968b] text-[16px]">${item.price}<span class="text-[9px] ml-0.5 font-normal">å…ƒ</span></div>
                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.original)}&tbm=isch" target="_blank" class="text-[9px] text-stone-300 underline font-black mt-1 inline-block">ğŸ” åœ–ç‰‡</a>
                        </div>
                    </div>
                    <div class="flex justify-end items-center gap-4">
                        <div onclick="updateCart('${item.id}', -1)" class="w-9 h-9 rounded-xl bg-stone-100 text-stone-400 font-black text-xl flex items-center justify-center active:bg-stone-200">ï¼</div>
                        <span class="text-2xl font-black min-w-[1.2rem] text-center">${qty}</span>
                        <div onclick="updateCart('${item.id}', 1)" class="w-9 h-9 rounded-xl bg-[#7d968b] text-white font-black text-xl flex items-center justify-center active:opacity-80">ï¼‹</div>
                    </div>
                </div>`;
            }).join('');
            updateGrandTotal();
        }

        function renderBill() {
            const container = document.getElementById('billListContainer');
            container.innerHTML = friends.map(f => {
                let sub = 0, itemsHtml = '';
                Object.entries(f.cart).forEach(([id, q]) => {
                    const it = menuItems.find(m => m.id === id);
                    if (it) { sub += it.price * q; itemsHtml += `<div class="flex flex-col py-2 border-b border-stone-50 font-bold"><div class="flex justify-between text-xs"><span>${it.translated} x ${q}</span><span>${(it.price * q).toLocaleString()}å…ƒ</span></div><div class="text-[9px] text-stone-300">${it.original}</div></div>`; }
                });
                const total = sub * (1 + taxRate / 100);
                if (sub === 0 && f.id !== 'share') return '';
                return `
                <div class="card-menu p-5 shadow-sm">
                    <div class="flex justify-between items-center border-b pb-3 mb-3">
                        <div class="flex items-center gap-2">
                            <div class="text-lg font-black">${f.name}</div>
                            <button onclick="clearMemberCart('${f.id}')" class="p-1 text-red-200 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                        <div class="text-xl font-black text-[#7d968b]">${total.toLocaleString()}å…ƒ</div>
                    </div>
                    <div class="space-y-1 mb-4">${itemsHtml || '<div class="text-[10px] text-stone-300 text-center py-2">å°šæœªé»é¤</div>'}</div>
                    ${sub > 0 ? `<div class="bg-stone-50 p-3 rounded-xl text-[9px] font-bold text-stone-400"><div class="flex justify-between"><span>å°è¨ˆ</span><span>${sub}å…ƒ</span></div><div class="flex justify-between"><span>ç¨…è²» (${taxRate}%)</span><span>+${(sub*taxRate/100).toFixed(0)}å…ƒ</span></div></div>` : ''}
                </div>`;
            }).join('');
        }

        function updateGrandTotal() {
            let t = 0; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { const it = menuItems.find(m => m.id === id); if (it) t += it.price * q; }); });
            document.getElementById('grandTotal').innerText = (t * (1 + taxRate / 100)).toLocaleString();
        }

        function updateFinanceSettings() { taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0; saveData(); updateGrandTotal(); if (!document.getElementById('view-bill').classList.contains('hidden')) renderBill(); }

        function switchTab(t) {
            const isMenu = t === 'menu';
            document.getElementById('view-menu').classList.toggle('hidden', !isMenu);
            document.getElementById('view-bill').classList.toggle('hidden', isMenu);
            document.getElementById('categoryWrapper').classList.toggle('hidden', !isMenu);
            document.getElementById('tab-menu').className = `flex-1 py-3 text-xs font-black border-b-4 ${isMenu ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-300'}`;
            document.getElementById('tab-bill').className = `flex-1 py-3 text-xs font-black border-b-4 ${!isMenu ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-300'}`;
            if (!isMenu) renderBill();
        }

        function clearAllData() { if (confirm("æ¸…é™¤èœå–®ï¼Ÿï¼ˆæˆå“¡åå­—å°‡ä¿ç•™ï¼‰")) { menuItems = []; restaurantInfo = ""; globalIdCounter = 0; friends.forEach(f => f.cart = {}); saveData(); location.reload(); } }

        async function compressImage(file) {
            return new Promise(resolve => {
                const img = new Image(); img.onload = () => {
                    const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 1100;
                    if (w > max || h > max) { if (w > h) { h *= max/w; w = max; } else { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                }; img.src = URL.createObjectURL(file);
            });
        }

        function updateCart(itemId, delta) {
            const f = friends.find(f => f.id === currentFriendId);
            const n = (f.cart[itemId] || 0) + delta;
            if (n >= 0) { if (n === 0) delete f.cart[itemId]; else f.cart[itemId] = n; saveData(); renderMenu(); }
        }

        function copyOrderToClipboard() {
            const tot = {}; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { tot[id] = (tot[id] || 0) + q; }); });
            let txt = "ğŸ“‹ é»é¤æ‘˜è¦:\n"; Object.entries(tot).forEach(([id, q]) => { const it = menuItems.find(m => m.id === id); txt += `â€¢ ${it.original} (${it.translated}) x ${q}\n`; });
            navigator.clipboard.writeText(txt).then(() => alert("å·²è¤‡è£½ï¼"));
        }

        function openFinalModal() {
            const tot = {}; friends.forEach(f => { Object.entries(f.cart).forEach(([id, q]) => { tot[id] = (tot[id] || 0) + q; }); });
            const list = document.getElementById('finalOrderList');
            if (Object.keys(tot).length === 0) return;
            list.innerHTML = Object.entries(tot).map(([id, q]) => {
                const it = menuItems.find(m => m.id === id);
                return `<div class="flex justify-between items-start border-b border-stone-100 pb-3 gap-3">
                    <div class="flex-1 min-w-0"><span class="font-black text-stone-900 block leading-tight text-[15px] break-words">${it.original}</span><span class="text-[10px] text-stone-400 block mt-0.5 break-words">${it.translated}</span></div>
                    <div class="text-2xl font-black text-[#7d968b] shrink-0 pt-0.5 tracking-tighter">x ${q}</div>
                </div>`;
            }).join('');
            document.getElementById('orderModal').classList.remove('hidden');
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const area = document.getElementById('previewArea'); area.innerHTML = '';
            document.getElementById('analyzeBtn').classList.remove('hidden');
            Array.from(e.target.files).forEach(f => {
                const img = document.createElement('img'); img.src = URL.createObjectURL(f);
                img.className = "w-full h-24 object-cover rounded-[1.5rem] border border-stone-100 shadow-sm"; area.appendChild(img);
            });
        });

        function renderInfo() { if (restaurantInfo.trim()) { document.getElementById('restaurantInfoBox').classList.remove('hidden'); document.getElementById('restaurantInfoContent').innerText = restaurantInfo; } }

        loadData();
    </script>
</body>
</html>